import openai
from flask import Flask, render_template, request, flash
from dotenv import load_dotenv
import os
from langdetect import detect, LangDetectException  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º langdetect
from fetch_article import fetch_article_text



load_dotenv()

app = Flask(__name__)
app.config['SECRET_KEY'] = 'your_secret_key'  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –†–ï–ê–õ–¨–ù–´–ô —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á!

openai.api_key = os.getenv('OPENAI_API_KEY')

PLATFORM_PROMPTS = {
    "twitter": """–¢—ã ‚Äì —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É –¥–ª—è Twitter (X).
–ù–∞–ø–∏—à–∏ —Ü–µ–ø–ª—è—é—â–∏–π —Ç–≤–∏—Ç –Ω–∞ —è–∑—ã–∫–µ {output_language} –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–µ–¥—É—é—â–µ–π –Ω–æ–≤–æ—Å—Ç–∏:
"{–ù–û–í–û–°–¢–¨}"

üìå –ü—Ä–∞–≤–∏–ª–∞:
- –î–ª–∏–Ω–∞: –¥–æ 200 —Å–∏–º–≤–æ–ª–æ–≤
- –ú–∏–Ω–∏–º—É–º "–≤–æ–¥—ã", —Ç–æ–ª—å–∫–æ —Å—É—Ç—å!
- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç—Ä–∏–≥—É –∏–ª–∏ –≤–æ–ø—Ä–æ—Å
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- –í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤—å 2-3 —Ö–µ—à—Ç–µ–≥–∞ –Ω–∞ —è–∑—ã–∫–µ {output_language}

üéØ –¢–≤–æ–π —Ç–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –µ–º–∫–∏–º, –Ω–æ –º–æ—â–Ω—ã–º!""",
    "instagram": """–¢—ã ‚Äì –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π SMM-–∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–µ—Ç —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ—Å—Ç—ã –¥–ª—è Instagram.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞–ø–∏—Å–∞—Ç—å –ø–æ—Å—Ç –Ω–∞ —è–∑—ã–∫–µ {output_language} –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–µ–¥—É—é—â–µ–π –Ω–æ–≤–æ—Å—Ç–∏:
"{–ù–û–í–û–°–¢–¨}"

üìå –ü—Ä–∞–≤–∏–ª–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è:
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –ø–æ—Å—Ç–∞: 150 —Å–∏–º–≤–æ–ª–æ–≤
- –°—Ç–∏–ª—å: –¥–∏–Ω–∞–º–∏—á–Ω—ã–π, —è—Ä–∫–∏–π, —Å —ç–º–æ—Ü–∏—è–º–∏
- –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏, —á—Ç–æ–±—ã –ø—Ä–∏–≤–ª–µ—á—å –≤–Ω–∏–º–∞–Ω–∏–µ
- –î–æ–±–∞–≤—å –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ß—Ç–æ –¥—É–º–∞–µ—Ç–µ? –î–µ–ª–∏—Ç–µ—Å—å –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö! üí¨")
- –í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤—å –¥–æ 5 –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ö–µ—à—Ç–µ–≥–æ–≤, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å —Ç–µ–º–æ–π, –Ω–∞ —è–∑—ã–∫–µ {output_language}

üéØ –¢–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫—Ä–∞—Ç–∫–∏–º, —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–º –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Å—Ç–∏–ª–∏—Å—Ç–∏–∫–µ Instagram!""",
    "facebook": """–¢—ã ‚Äì –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –ø–∏—à–µ—Ç –ø–æ—Å—Ç—ã –¥–ª—è Facebook.
–ù–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–µ–¥—É—é—â–µ–π –Ω–æ–≤–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–π –≤–æ–≤–ª–µ–∫–∞—é—â–∏–π –ø–æ—Å—Ç –Ω–∞ —è–∑—ã–∫–µ {output_language}:
"{–ù–û–í–û–°–¢–¨}"

üìå –ü—Ä–∞–≤–∏–ª–∞:
- –î–ª–∏–Ω–∞: 200-500 —Å–∏–º–≤–æ–ª–æ–≤
- –§–æ—Ä–º–∞—Ç: 2-3 –∞–±–∑–∞—Ü–∞, –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö —Ñ—Ä–∞–∑
- –î–æ–±–∞–≤—å –ø—Ä–∏–∑—ã–≤ –∫ –æ–±—Å—É–∂–¥–µ–Ω–∏—é
- –í –∫–æ–Ω—Ü–µ ‚Äî 3-4 —Ö–µ—à—Ç–µ–≥–∞ –Ω–∞ —è–∑—ã–∫–µ {output_language}

üéØ –¢–≤–æ–π —Ç–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º –∏ —É–¥–æ–±–Ω—ã–º –¥–ª—è —á—Ç–µ–Ω–∏—è!""",
    "tiktok": """–¢—ã ‚Äì –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç-–º–µ–π–∫–µ—Ä TikTok.
–°–æ–∑–¥–∞–π –æ–ø–∏—Å–∞–Ω–∏–µ –∫ –≤–∏–¥–µ–æ –Ω–∞ —è–∑—ã–∫–µ {output_language} –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–π –Ω–æ–≤–æ—Å—Ç–∏:
"{–ù–û–í–û–°–¢–¨}"

üìå –§–æ—Ä–º–∞—Ç:
- –ú–∞–∫—Å–∏–º—É–º 150 —Å–∏–º–≤–æ–ª–æ–≤
- –ú–∏–Ω–∏–º—É–º "–≤–æ–¥—ã", –º–∞–∫—Å–∏–º—É–º –≤–æ–≤–ª–µ—á–µ–Ω–∏—è
- –î–æ–±–∞–≤—å 4-5 –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ö–µ—à—Ç–µ–≥–æ–≤ –Ω–∞ —è–∑—ã–∫–µ {output_language}

üéØ –î–æ–ª–∂–Ω–æ –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫, –±—É–¥—Ç–æ —ç—Ç–æ —Ç—Ä–µ–Ω–¥–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç TikTok!""",
    "telegram": """–¢—ã ‚Äì –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π Telegram-–∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä.
–ù–∞–ø–∏—à–∏ –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π, –Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –ø–æ—Å—Ç –Ω–∞ —è–∑—ã–∫–µ {output_language} –ø–æ —ç—Ç–æ–π –Ω–æ–≤–æ—Å—Ç–∏:
"{–ù–û–í–û–°–¢–¨}"

üìå –£—Å–ª–æ–≤–∏—è:
- –î–ª–∏–Ω–∞: 200-400 —Å–∏–º–≤–æ–ª–æ–≤
- –ù–µ —Å–ª–∏—à–∫–æ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ, –Ω–æ –∏ –Ω–µ "–∂—ë–ª—Ç–∞—è –ø—Ä–µ—Å—Å–∞"
- –í–∞–∂–Ω—ã–µ —Ñ–∞–∫—Ç—ã + –ª–µ–≥–∫–∏–π –Ω–∞–º–µ–∫ –Ω–∞ –≤—ã–≤–æ–¥
- 2-3 —Ö–µ—à—Ç–µ–≥–∞ –≤ –∫–æ–Ω—Ü–µ –Ω–∞ —è–∑—ã–∫–µ {output_language}

üéØ –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω—ã–º –∏ —á–∏—Ç–∞–±–µ–ª—å–Ω—ã–º!""",
    "pinterest": """–¢—ã ‚Äì –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä –¥–ª—è Pinterest.
–°–æ–∑–¥–∞–π –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø–∏–Ω–∞ –Ω–∞ —è–∑—ã–∫–µ {output_language} –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–π –Ω–æ–≤–æ—Å—Ç–∏:
"{–ù–û–í–û–°–¢–¨}"

üìå –£—Å–ª–æ–≤–∏—è:
- –î–ª–∏–Ω–∞: –¥–æ 500 —Å–∏–º–≤–æ–ª–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–π –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π –∏ –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π —Å—Ç–∏–ª—å
- –ü—Ä–∏–∑—ã–≤–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–∏–Ω –∏–ª–∏ –¥–µ–ª–∏—Ç—å—Å—è –∏–º
- –í–∫–ª—é—á–∏ 3-4 —Ö–µ—à—Ç–µ–≥–∞ –Ω–∞ —è–∑—ã–∫–µ {output_language}

üéØ –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–º –∏ –ª–µ–≥–∫–æ –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞–µ–º—ã–º!""",
    "youtube": """–¢—ã ‚Äì —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É –¥–ª—è YouTube.
–ù–∞–ø–∏—à–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∏–¥–µ–æ –Ω–∞ —è–∑—ã–∫–µ {output_language}, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π –Ω–æ–≤–æ—Å—Ç–∏:
"{–ù–û–í–û–°–¢–¨}"

üìå –£—Å–ª–æ–≤–∏—è:
- –î–ª–∏–Ω–∞: –¥–æ 300 —Å–∏–º–≤–æ–ª–æ–≤
- –ö—Ä–∞—Ç–∫–æ —Ä–∞—Å—Å–∫–∞–∂–∏ –æ —Ç–µ–º–µ –≤–∏–¥–µ–æ
- –ò—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Å—Ç–∏–ª—å, —á—Ç–æ–±—ã –≤–æ–≤–ª–µ—á—å –∑—Ä–∏—Ç–µ–ª—è
- –ü—Ä–∏–∑–æ–≤–∏ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
- –î–æ–±–∞–≤—å 2-3 —Ö–µ—à—Ç–µ–≥–∞ –Ω–∞ —è–∑—ã–∫–µ {output_language}

üéØ –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º, –Ω–æ —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ –∏–Ω—Ç—Ä–∏–≥–∏!"""
}

def detect_language(text):
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —è–∑—ã–∫ —Ç–µ–∫—Å—Ç–∞."""
    try:
        return detect(text)
    except LangDetectException:
        return 'en'  # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é


def generate_social_media_text(news_text, platform, output_language):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –¥–ª—è —Å–æ—Ü—Å–µ—Ç–∏ —Å —É—á–µ—Ç–æ–º —è–∑—ã–∫–∞."""
    prompt = PLATFORM_PROMPTS.get(platform)
    if not prompt:
        return {"text": "–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.", "success": False, "warning": None}
    
    # news_language = detect_language(news_text) #–û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫ —Ç–µ–∫—Å—Ç–∞ –Ω–æ–≤–æ—Å—Ç–∏. (–≠—Ç–æ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–æ)

    prompt = prompt.format(–ù–û–í–û–°–¢–¨=news_text, output_language=output_language) #, news_language=news_language)

    if not openai.api_key:
        return {"text": "–û—à–∏–±–∫–∞: API-–∫–ª—é—á OpenAI –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.  –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è OPENAI_API_KEY.", "success": False, "warning": None}

    try:
        client = openai.OpenAI()
        response = client.chat.completions.create(
            model="gpt-4-turbo",
            messages=[
                {"role": "system", "content": "You are a helpful assistant."},
                {"role": "user", "content": prompt}
            ],
            max_tokens=400,
            temperature=0.7,
        )
        generated_text = response.choices[0].message.content.strip()
        return {"text": generated_text, "success": True, "warning": None}

    except openai.APIError as e:
        return {"text": f"–û—à–∏–±–∫–∞ OpenAI: {e}", "success": False, "warning": None}
    except Exception as e:
        return {"text": f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}", "success": False, "warning": None}


@app.route('/', methods=['GET', 'POST'])
def index():
    generated_texts = {}
    if request.method == 'POST':
        news_text = request.form['news_text'].strip()
        platforms = request.form.getlist('platforms')
        output_language = request.form['output_language']  # –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫

        if not news_text:
            flash("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏.", "error")
            return render_template('index.html', generated_texts=generated_texts)

        if not platforms:
            flash("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Å–æ—Ü—Å–µ—Ç—å.", "error")
            return render_template('index.html', generated_texts=generated_texts)

        for platform in platforms:
            result = generate_social_media_text(news_text, platform, output_language) # –ü–µ—Ä–µ–¥–∞—ë–º —è–∑—ã–∫
            generated_texts[platform] = result

    return render_template('index.html', generated_texts=generated_texts)


if __name__ == '__main__':
    app.run(debug=True)